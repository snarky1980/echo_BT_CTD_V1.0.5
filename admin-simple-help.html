<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aide â€” Console simple</title>
    <meta name="robots" content="noindex, nofollow" />
    <style>
      :root { --border:#e2e8f0; --muted:#64748b; --ink:#0f172a; --teal:#059669; }
      *{box-sizing:border-box}
      body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;color:var(--ink)}
      header{position:sticky;top:0;display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--border);background:#fff}
      .title{font-weight:800}
      .spacer{flex:1}
      .btn{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
      .btn.primary{background:var(--teal);border-color:var(--teal);color:#fff}
      main{padding:16px;max-width:900px;margin:0 auto}
      .chip{display:inline-block;background:#ecfeff;color:#0e7490;border:1px solid #bae6fd;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
      h2{margin:10px 0}
      h3{margin:10px 0}
      .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,.06);padding:14px}
      code{background:#f1f5f9;border:1px solid var(--border);border-radius:6px;padding:0 4px}
      ol{margin:0 0 12px 18px}
      ul{margin:0 0 0 18px}
      footer{padding:12px;color:var(--muted);text-align:center}
      @media (max-width: 700px){ main{padding:12px} }
      /* new utility classes */
      .mb12{margin-bottom:12px}
      .para{margin-top:6px}
      .note{font-size:12px;color:var(--muted);margin:0}
      .focus-btn{margin-left:6px;padding:2px 8px;font-size:11px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer}
      .focus-btn:hover{background:#f1f5f9}
      .form-grid{display:grid;gap:16px}
      .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .fld-label{display:block;font-size:12px;font-weight:700;color:var(--muted);margin-bottom:4px}
      .req{color:#dc2626}
      .fld-input{width:100%;border:1px solid var(--border);padding:8px 10px;border-radius:8px;font:inherit}
      .fld-textarea{width:100%;border:1px solid var(--border);padding:8px 10px;border-radius:8px;font:inherit;min-height:100px;resize:vertical}
      .fld-textarea.short{min-height:80px}
      .hint{font-size:11px;color:var(--muted);margin-top:2px}
      .lang-hdr{margin:8px 0 0;padding-top:8px;border-top:1px solid var(--border)}
      .submit-notice{display:none;padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;font-weight:600}
      .hidden{display:none}
      .mt16{margin-top:16px}
      .actions{display:flex;gap:8px;justify-content:flex-end;padding-top:8px;border-top:1px solid var(--border)}
      .lead{color:var(--muted);font-size:14px;margin:0 0 16px}
      /* highlight style injected in parent may exist; keeping a local variant */
      .ea-highlight-pulse{outline:3px solid #0ea5e9!important;animation:eaPulse 1.2s linear infinite;border-radius:8px}
      @keyframes eaPulse{0%,100%{outline-color:#0ea5e9}50%{outline-color:#fbbf24}}
    </style>
  </head>
  <body>
    <header>
      <div class="title">Aide â€” GÃ©rer les modÃ¨les (mode simple)</div>
      <div class="spacer"></div>
      <button class="btn" id="btn-toggle-submit" onclick="toggleSubmitForm()">ğŸ“ Soumettre un modÃ¨le</button>
      <button class="btn" onclick="window.close()">Fermer</button>
    </header>
    <main>
      <div class="card mb12">
        <div class="chip">Info</div>
        <div class="para">Tout reste en <strong>brouillon local</strong> (stockÃ© dans votre navigateur) jusquâ€™Ã  ce que vous exportiez. Â« RÃ©initialiser Â» recharge le fichier officiel.</div>
      </div>

      <section class="card mb12">
        <h3>1. Modifier un modÃ¨le existant</h3>
        <ol>
          <li><strong>SÃ©lection</strong> â€” Dans la colonne de gauche, cliquez sur la tuile du modÃ¨le. <button type="button" class="focus-btn" data-target="list">Voir</button></li>
          <li><strong>Langue</strong> â€” Utilisez le sÃ©lecteur FR / EN en haut si vous devez changer la langue Ã©ditÃ©e.</li>
          <li><strong>Champs</strong> â€” Modifiez <em>Titre</em>, <em>Description</em>, <em>Objet</em>, puis le <em>Corps</em>. <button type="button" class="focus-btn" data-target="tpl-title-fr">Titre FR</button> <button type="button" class="focus-btn" data-target="tpl-body-fr">Corps FR</button></li>
          <li><strong>Variables</strong> â€” Tapez les placeholders <code>&lt;&lt;NomVariable&gt;&gt;</code> dans Objet/Corps. Elles sont dÃ©tectÃ©es automatiquement et listÃ©es en bas.</li>
          <li><strong>Sauvegarde</strong> â€” Â« Exporter JSON Â» ou Â« Exporter Excel Â». <button type="button" class="focus-btn" data-target="btn-export">JSON</button> <button type="button" class="focus-btn" data-target="btn-export-xlsx">Excel</button></li>
        </ol>
      </section>

      <section class="card mb12">
        <h3>2. Supprimer un modÃ¨le</h3>
        <ol>
          <li><strong>SÃ©lection</strong> â€” Cliquez la tuile. <button type="button" class="focus-btn" data-target="list">Voir</button></li>
          <li><strong>Action</strong> â€” Cliquez Â« Supprimer Â». <button type="button" class="focus-btn" data-target="btn-delete">Supprimer</button></li>
          <li>Le modÃ¨le disparaÃ®t de la liste. Si erreur, utilisez Â« RÃ©initialiser Â» pour restaurer lâ€™Ã©tat officiel.</li>
          <li>Exportez le JSON si vous devez transmettre la mise Ã  jour sans ce modÃ¨le.</li>
        </ol>
        <p class="note">AstuceÂ : la suppression ne touche que votre brouillon tant que vous nâ€™avez pas remplacÃ© le fichier officiel.</p>
      </section>

      <section class="card mb12">
        <h3>3. Ajouter un nouveau modÃ¨le</h3>
        <ol>
          <li><strong>CrÃ©ation</strong> â€” Dans la colonne de gauche (Â« ModÃ¨les Â»), cliquez Â« Ajouter un modÃ¨le Â». <button type="button" class="focus-btn" data-target="btn-new">Ajouter un modÃ¨le</button></li>
          <li><strong>ID</strong> â€” Saisissez un identifiant simple (lettres, chiffres, underscore). Exemple: <code>welcome_client</code>.</li>
          <li><strong>ComplÃ©tez</strong> les champs FR et EN (Titre, Description, Objet, Corps). <button type="button" class="focus-btn" data-target="tpl-id">ID</button></li>
          <li><strong>Placeholders</strong> â€” InsÃ©rez les variables nÃ©cessaires: <code>&lt;&lt;ClientName&gt;&gt;</code>, <code>&lt;&lt;ProjectNumber&gt;&gt;</code>, etc. Elles sont dÃ©tectÃ©es automatiquement.</li>
          <li><strong>VÃ©rifiez</strong> lâ€™orthographe, accents, cohÃ©rence FR/EN.</li>
          <li><strong>Exportez</strong> via Â« Exporter JSON Â» pour transmettre le nouveau modÃ¨le ou via Â« Exporter Excel Â» si vous prÃ©parez plusieurs ajouts.</li>
        </ol>
        <p class="note">Besoin dâ€™aide pour dÃ©crire les variables ? Ajoutez leur nom puis revenez plus tard complÃ©ter les descriptions.</p>
      </section>

      <section class="card mb12">
        <h3>4. Modifier plusieurs modÃ¨les avec Excel (optionnel)</h3>
        <ol>
          <li>Cliquez Â« Exporter Excel Â» pour obtenir tous les modÃ¨les.</li>
          <li>Ouvrez le fichier .xlsx et modifiez / ajoutez des lignes (garder la syntaxe <code>&lt;&lt;Var&gt;&gt;</code>).</li>
          <li>Importez avec Â« Importer Excel Â» pour charger les changements en brouillon.</li>
          <li>Revoyez chaque tuile si nÃ©cessaire puis exportez en JSON pour diffusion.</li>
        </ol>
      </section>

      <section class="card">
        <h3>FAQ rapide</h3>
        <ul>
          <li><strong>ID en doublon</strong> â€” un suffixe automatique est ajoutÃ© lors de lâ€™import Excel.</li>
          <li><strong>Variables non vues</strong> â€” relancez Â« Sync variables Â» aprÃ¨s vos modifications de texte.</li>
          <li><strong>Perte de changements</strong> â€” Ã©vitez de vider votre cache navigateur et exportez rÃ©guliÃ¨rement.</li>
          <li><strong>RÃ©initialiser</strong> â€” recharge la version officielle et efface votre brouillon local.</li>
        </ul>
      </section>

      <!-- Submit Template Form -->
      <section id="submit-form-section" class="card hidden mt16">
        <h3>ğŸ“ Soumettre un nouveau modÃ¨le</h3>
        <p class="para lead">Partagez un modÃ¨le d'email que vous souhaitez ajouter Ã  la bibliothÃ¨que.</p>
        
        <div id="submit-notice" class="submit-notice"></div>

        <form id="submit-form" class="form-grid">
          <div>
            <label class="fld-label">ID du modÃ¨le <span class="req">*</span></label>
            <input type="text" id="template-id" class="fld-input" placeholder="ex: welcome_email" required />
            <div class="hint">Identifiant unique (lettres, chiffres, underscore)</div>
          </div>

          <div class="two-col">
            <div>
              <label class="fld-label">CatÃ©gorie (FR) <span class="req">*</span></label>
              <input type="text" id="category-fr" class="fld-input" placeholder="Service client" required />
            </div>
            <div>
              <label class="fld-label">CatÃ©gorie (EN) <span class="req">*</span></label>
              <input type="text" id="category-en" class="fld-input" placeholder="Customer Care" required />
            </div>
          </div>

          <h4 class="lang-hdr">ğŸ‡«ğŸ‡· Version franÃ§aise</h4>
          
          <div>
            <label class="fld-label">Titre (FR) <span class="req">*</span></label>
            <input type="text" id="title-fr" class="fld-input" placeholder="Bienvenue â€“ Nouveau client" required />
          </div>

          <div>
            <label class="fld-label">Description (FR) <span class="req">*</span></label>
            <input type="text" id="description-fr" class="fld-input" placeholder="Courriel de bienvenue" required />
          </div>

          <div>
            <label class="fld-label">Objet (FR) <span class="req">*</span></label>
            <input type="text" id="subject-fr" class="fld-input" placeholder="Bienvenue !" required />
          </div>

          <div>
            <label class="fld-label">Corps (FR) <span class="req">*</span></label>
            <textarea id="body-fr" class="fld-textarea" placeholder="Bonjour <<nom_client>>,&#10;&#10;Nous sommes ravis..." required></textarea>
            <div class="hint">Utilisez &lt;&lt;nom_variable&gt;&gt; pour les placeholders</div>
          </div>

          <h4 class="lang-hdr">ğŸ‡¬ğŸ‡§ English version</h4>
          
          <div>
            <label class="fld-label">Title (EN) <span class="req">*</span></label>
            <input type="text" id="title-en" class="fld-input" placeholder="Welcome â€“ New customer" required />
          </div>

          <div>
            <label class="fld-label">Description (EN) <span class="req">*</span></label>
            <input type="text" id="description-en" class="fld-input" placeholder="Welcome email" required />
          </div>

          <div>
            <label class="fld-label">Subject (EN) <span class="req">*</span></label>
            <input type="text" id="subject-en" class="fld-input" placeholder="Welcome!" required />
          </div>

          <div>
            <label class="fld-label">Body (EN) <span class="req">*</span></label>
            <textarea id="body-en" class="fld-textarea" placeholder="Hello <<customer_name>>,&#10;&#10;We're excited..." required></textarea>
            <div class="hint">Use &lt;&lt;variable_name&gt;&gt; for placeholders</div>
          </div>

          <h4 class="lang-hdr">ğŸ“‹ Variables (optionnel)</h4>
          
          <div>
            <label class="fld-label">Description des variables (FR)</label>
            <textarea id="variables-fr" class="fld-textarea short" placeholder="<<nom_client>>:Nom du client(Jean)&#10;<<numero_compte>>:NumÃ©ro de compte(AC-12345)"></textarea>
            <div class="hint">Format: &lt;&lt;variable&gt;&gt;:Description(Exemple) â€“ une par ligne</div>
          </div>

          <div>
            <label class="fld-label">Variables description (EN)</label>
            <textarea id="variables-en" class="fld-textarea short" placeholder="<<customer_name>>:Customer name(John)&#10;<<account_number>>:Account number(AC-12345)"></textarea>
            <div class="hint">Format: &lt;&lt;variable&gt;&gt;:Description(Example) â€“ one per line</div>
          </div>

          <div class="two-col">
            <div>
              <label class="fld-label">Votre nom</label>
              <input type="text" id="submitter-name" class="fld-input" placeholder="Jean Dupont" />
            </div>
            <div>
              <label class="fld-label">Votre email</label>
              <input type="email" id="submitter-email" class="fld-input" placeholder="jean@example.com" />
            </div>
          </div>

          <div>
            <label class="fld-label">Notes</label>
            <textarea id="notes" class="fld-textarea short" placeholder="Commentaires ou contexte..."></textarea>
          </div>

          <div class="actions">
            <button type="button" class="btn" onclick="toggleSubmitForm()">Annuler</button>
            <button type="submit" class="btn primary">ğŸ“¤ Soumettre</button>
          </div>
        </form>
      </section>
    </main>
    <footer>AstuceÂ : vous pouvez garder cette fenÃªtre ouverte pendant que vous travaillez.</footer>
    <script>
      // Focus the window, hint for accessibility
      window.focus?.();

      const submitSection = document.getElementById('submit-form-section');
      const submitNotice = document.getElementById('submit-notice');
      const submitForm = document.getElementById('submit-form');
      const btnToggle = document.getElementById('btn-toggle-submit');

      function toggleSubmitForm() {
        const isVisible = submitSection.style.display !== 'none';
        submitSection.style.display = isVisible ? 'none' : 'block';
        btnToggle.textContent = isVisible ? 'ğŸ“ Soumettre un modÃ¨le' : 'âŒ Fermer le formulaire';
        if (!isVisible) {
          submitSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      function showNotice(msg, type = 'success') {
        submitNotice.textContent = msg;
        submitNotice.style.display = 'block';
        submitNotice.style.background = type === 'success' ? '#d1fae5' : '#fee2e2';
        submitNotice.style.color = type === 'success' ? '#065f46' : '#991b1b';
        submitNotice.style.border = type === 'success' ? '1px solid #6ee7b7' : '1px solid #fca5a5';
        setTimeout(() => submitNotice.style.display = 'none', 5000);
      }

      // Sanitize ID input
      document.getElementById('template-id').addEventListener('input', (e) => {
        const val = e.target.value;
        const sanitized = val.replace(/[^A-Za-z0-9_]+/g, '_');
        if (val !== sanitized) e.target.value = sanitized;
      });

      submitForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
          id: document.getElementById('template-id').value.trim(),
          category_fr: document.getElementById('category-fr').value.trim(),
          category_en: document.getElementById('category-en').value.trim(),
          title_fr: document.getElementById('title-fr').value.trim(),
          title_en: document.getElementById('title-en').value.trim(),
          description_fr: document.getElementById('description-fr').value.trim(),
          description_en: document.getElementById('description-en').value.trim(),
          subject_fr: document.getElementById('subject-fr').value.trim(),
          subject_en: document.getElementById('subject-en').value.trim(),
          body_fr: document.getElementById('body-fr').value.trim(),
          body_en: document.getElementById('body-en').value.trim(),
          variables_fr: document.getElementById('variables-fr').value.trim(),
          variables_en: document.getElementById('variables-en').value.trim(),
          submitter_name: document.getElementById('submitter-name').value.trim(),
          submitter_email: document.getElementById('submitter-email').value.trim(),
          notes: document.getElementById('notes').value.trim(),
          timestamp: new Date().toISOString()
        };

        try {
          // Save to localStorage for the admin console to pick up
          const existingSubmissions = JSON.parse(localStorage.getItem('ea_template_submissions') || '[]');
          existingSubmissions.push(formData);
          localStorage.setItem('ea_template_submissions', JSON.stringify(existingSubmissions));

          // Generate a downloadable JSON file
          const blob = new Blob([JSON.stringify(formData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `template_submission_${formData.id}_${Date.now()}.json`;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            URL.revokeObjectURL(url);
            a.remove();
          }, 1000);

          showNotice('âœ… ModÃ¨le soumis avec succÃ¨s ! Un fichier JSON a Ã©tÃ© tÃ©lÃ©chargÃ©.', 'success');
          
          // Reset form after 2 seconds
          setTimeout(() => {
            submitForm.reset();
          }, 2000);

        } catch (error) {
          console.error('Submission error:', error);
          showNotice('âŒ Erreur lors de la soumission. Veuillez rÃ©essayer.', 'error');
        }
      });

      // Highlight guidance linking to parent admin window
      function highlightTarget(id){
        const parent = window.opener?.document;
        if(!parent) return;
        const el = parent.getElementById(id);
        if(!el) return;
        // Inject style if missing
        if(!parent.getElementById('ea-highlight-style')){
          const st = parent.createElement('style');
          st.id='ea-highlight-style';
          st.textContent='.ea-highlight-pulse{outline:3px solid #0ea5e9!important;animation:eaPulse 1.2s linear infinite;border-radius:8px}@keyframes eaPulse{0%,100%{outline-color:#0ea5e9}50%{outline-color:#fbbf24}}';
          parent.head.appendChild(st);
        }
        el.scrollIntoView({behavior:'smooth',block:'center'});
        el.classList.add('ea-highlight-pulse');
        el.focus?.();
        setTimeout(()=>el.classList.remove('ea-highlight-pulse'),3000);
      }
      document.querySelectorAll('.focus-btn').forEach(btn=>{
        btn.addEventListener('click',()=>highlightTarget(btn.dataset.target));
      });
    </script>
  </body>
  </html>
